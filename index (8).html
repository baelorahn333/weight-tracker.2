<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#2f2f2f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ì²´ì¤‘ê¸°ë¡" />
  <meta name="description" content="ì²´ì¤‘ì„ ê¸°ë¡í•˜ê³  ë³€í™”ë¥¼ ì¶”ì í•˜ì„¸ìš”" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <title>ì²´ì¤‘ê¸°ë¡ v2</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #2f2f2f;
      --bg2: #3a3a3a;
      --border: #4a4a4a;
      --border2: #505050;
      --text: #ececec;
      --text-secondary: #b4b4b4;
      --muted: #8e8e8e;
      --dim: #666666;
      --accent: #7fff7f;
      --yellow: #ffd700;
      --danger: #ff7f7f;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    body {
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(47,47,47,0.95);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      padding: 18px 20px 16px;
      padding-top: calc(18px + env(safe-area-inset-top));
    }
    .header-label { 
      font-size: 11px; 
      letter-spacing: 0.22em; 
      color: var(--muted); 
      text-transform: uppercase; 
      margin-bottom: 4px;
      font-weight: 500;
    }
    .header-title { 
      font-size: 24px; 
      letter-spacing: -0.02em;
      font-weight: 400;
      color: var(--text);
    }
    .header-title span { color: var(--accent); font-weight: 500; }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      position: sticky;
      top: calc(72px + env(safe-area-inset-top));
      z-index: 40;
    }
    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      color: var(--dim);
      font-family: var(--font);
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      padding: 15px 0;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.15s, border-color 0.15s;
      font-weight: 500;
    }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* â”€â”€ Sections â”€â”€ */
    .page { display: none; padding: 20px 20px 40px; max-width: 640px; margin: 0 auto; }
    .page.active { display: block; }

    .section { margin-top: 28px; }
    .section:first-child { margin-top: 0; }
    .section-label { 
      font-size: 11px; 
      letter-spacing: 0.16em; 
      color: var(--muted); 
      text-transform: uppercase; 
      margin-bottom: 14px;
      font-weight: 500;
    }

    /* â”€â”€ Stats â”€â”€ */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .stat-lbl { 
      font-size: 10px; 
      color: var(--muted); 
      letter-spacing: 0.12em; 
      text-transform: uppercase; 
      margin-bottom: 8px;
      font-weight: 500;
    }
    .stat-val { 
      font-size: 28px; 
      letter-spacing: -0.03em;
      font-weight: 400;
      color: var(--text);
    }
    .stat-unit { font-size: 13px; color: var(--text-secondary); margin-left: 2px; font-weight: 400; }
    .green { color: var(--accent); }
    .red { color: var(--danger); }
    .gray { color: var(--muted); }

    /* â”€â”€ Chart â”€â”€ */
    .chart-wrap { 
      background: var(--bg2); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 16px 10px 10px; 
      overflow: hidden; 
      position: relative; 
    }
    .chart-empty { 
      text-align: center; 
      color: var(--muted); 
      font-size: 13px; 
      padding: 60px 0; 
      letter-spacing: 0.06em;
      line-height: 1.8;
    }
    svg.chart { width: 100%; display: block; }
    .tooltip-box { 
      position: absolute; 
      background: #1a1a1a; 
      border: 1px solid #2e2e2e; 
      border-radius: 7px; 
      padding: 10px 14px; 
      font-size: 11px; 
      pointer-events: none; 
      z-index: 10; 
      display: none;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    .tooltip-date { color: var(--muted); margin-bottom: 4px; font-weight: 500; }
    .tooltip-weight { color: var(--accent); font-size: 17px; font-weight: 500; }
    .tooltip-avg { color: var(--yellow); font-size: 17px; font-weight: 500; margin-top: 4px; }

    /* â”€â”€ Form â”€â”€ */
    .date-nav-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .date-nav-btn {
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: 8px;
      color: var(--text);
      font-size: 18px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      transition: border-color 0.15s, opacity 0.15s;
      font-family: var(--font);
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    .date-nav-btn:active { opacity: 0.7; }
    .date-nav-btn:hover { border-color: var(--accent); }
    
    .form-group { display: flex; flex-direction: column; gap: 7px; flex: 1; }
    .form-label { 
      font-size: 11px; 
      color: var(--muted); 
      letter-spacing: 0.12em; 
      text-transform: uppercase;
      font-weight: 500;
    }
    input[type="date"], input[type="number"] {
      background: var(--bg2);
      border: 1px solid var(--border2);
      border-radius: 8px;
      padding: 12px 14px;
      color: var(--text);
      font-size: 16px;
      font-family: var(--font);
      outline: none;
      width: 100%;
      transition: border-color 0.15s;
      -webkit-appearance: none;
      font-weight: 400;
    }
    input:focus { border-color: var(--accent); }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }
    
    .weight-input-group {
      display: flex;
      flex-direction: column;
      gap: 7px;
      margin-bottom: 14px;
    }
    
    .add-btn {
      width: 100%; 
      background: var(--accent); 
      color: #1a1a1a;
      border: none; 
      border-radius: 8px; 
      padding: 15px;
      font-size: 14px; 
      font-family: var(--font); 
      letter-spacing: 0.1em;
      cursor: pointer; 
      font-weight: 600; 
      transition: opacity 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .add-btn:active { opacity: 0.8; }

    /* â”€â”€ History â”€â”€ */
    .history-item {
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 15px 0; 
      border-bottom: 1px solid #181818;
    }
    .hist-date { 
      font-size: 11px; 
      color: var(--muted); 
      margin-bottom: 5px;
      font-weight: 500;
      letter-spacing: 0.04em;
    }
    .hist-weight { 
      font-size: 21px; 
      letter-spacing: -0.02em;
      color: var(--text);
      font-weight: 400;
    }
    .hist-unit { font-size: 12px; color: var(--text-secondary); font-weight: 400; }
    .hist-delta { font-size: 12px; margin-left: 8px; font-weight: 500; }
    .del-btn {
      background: none; 
      border: 1px solid #222; 
      border-radius: 6px;
      color: var(--dim); 
      font-size: 11px; 
      padding: 7px 13px; 
      cursor: pointer;
      font-family: var(--font); 
      letter-spacing: 0.06em; 
      transition: all 0.15s;
      white-space: nowrap; 
      -webkit-tap-highlight-color: transparent;
      font-weight: 500;
    }
    .del-confirm { color: var(--danger); border-color: #3a1a1a; }
    .cancel-btn { color: var(--dim); border-color: #222; }
    .del-actions { display: flex; gap: 7px; }
    .empty-state { 
      text-align: center; 
      color: var(--muted); 
      font-size: 13px; 
      padding: 52px 0; 
      letter-spacing: 0.05em; 
      line-height: 2;
    }

    /* â”€â”€ Backup â”€â”€ */
    .backup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .backup-btn {
      background: var(--bg2); 
      border: 1px solid var(--border2); 
      border-radius: 8px;
      padding: 17px 13px; 
      color: var(--text); 
      font-family: var(--font);
      font-size: 12px; 
      letter-spacing: 0.07em; 
      cursor: pointer;
      transition: border-color 0.15s, opacity 0.15s; 
      text-align: center;
      -webkit-tap-highlight-color: transparent;
      font-weight: 500;
    }
    .backup-btn:active { opacity: 0.7; }
    .backup-btn:hover { border-color: var(--accent); }
    .backup-btn.danger:hover { border-color: var(--danger); }
    .backup-icon { font-size: 24px; display: block; margin-bottom: 9px; }
    .backup-desc { 
      font-size: 10px; 
      color: var(--muted); 
      margin-top: 5px; 
      letter-spacing: 0.05em;
      font-weight: 400;
    }
    .backup-info { 
      background: var(--bg2); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 15px 17px; 
      font-size: 12px; 
      color: var(--text-secondary); 
      line-height: 1.9; 
      margin-top: 10px;
      font-weight: 400;
    }
    .file-input { display: none; }

    /* â”€â”€ Toast â”€â”€ */
    .toast {
      position: fixed; 
      bottom: calc(26px + env(safe-area-inset-bottom));
      left: 50%; 
      transform: translateX(-50%) translateY(12px);
      background: #1a1a1a; 
      border: 1px solid #2a2a2a;
      border-radius: 8px; 
      padding: 13px 24px;
      font-size: 13px; 
      letter-spacing: 0.05em;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
      z-index: 999; 
      opacity: 0; 
      transition: all 0.2s;
      white-space: nowrap;
      color: var(--text);
      font-weight: 500;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.error { color: var(--danger); border-color: #3a1a1a; }

    /* â”€â”€ Scrollbar â”€â”€ */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 2px; }

    /* â”€â”€ Install Banner â”€â”€ */
    .install-banner {
      background: var(--bg2); 
      border: 1px solid var(--border2); 
      border-radius: 10px;
      padding: 15px 17px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      gap: 13px; 
      margin-bottom: 22px;
    }
    .install-text { 
      font-size: 12px; 
      color: var(--text-secondary); 
      line-height: 1.6;
      font-weight: 400;
    }
    .install-btn {
      background: var(--accent); 
      color: #1a1a1a; 
      border: none; 
      border-radius: 6px;
      padding: 9px 15px; 
      font-family: var(--font); 
      font-size: 11px;
      font-weight: 600; 
      letter-spacing: 0.07em; 
      cursor: pointer; 
      white-space: nowrap;
    }
  </style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-label">Weight Tracker v2</div>
  <div class="header-title">ì²´ì¤‘ <span>ê¸°ë¡</span></div>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('home')">í™ˆ</button>
  <button class="tab-btn" onclick="switchTab('add')">ê¸°ë¡í•˜ê¸°</button>
  <button class="tab-btn" onclick="switchTab('history')">ë‚´ì—­</button>
  <button class="tab-btn" onclick="switchTab('backup')">ë°±ì—…</button>
</div>

<!-- HOME TAB -->
<div id="tab-home" class="page active">

  <div id="install-banner" class="install-banner" style="display:none;">
    <div class="install-text">ğŸ“² í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´<br>ì•±ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”</div>
    <button class="install-btn" onclick="installApp()">í™ˆì— ì¶”ê°€</button>
  </div>

  <div class="section">
    <div class="section-label">Overview</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-lbl">ì‹œì‘ ì²´ì¤‘</div>
        <div class="stat-val" id="stat-start">â€”</div>
      </div>
      <div class="stat-card">
        <div class="stat-lbl">ì´ ë³€í™”ëŸ‰</div>
        <div class="stat-val gray" id="stat-change">â€”</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-label" id="chart-label">ë³€í™” ì¶”ì´</div>
    <div class="chart-wrap">
      <div class="chart-empty" id="chart-empty">ê¸°ë¡ì´ 2ê°œ ì´ìƒì´ë©´<br>ê·¸ë˜í”„ê°€ ë‚˜íƒ€ë‚˜ìš”</div>
      <svg class="chart" id="chart-svg" style="display:none;" viewBox="0 0 560 270"></svg>
      <div class="tooltip-box" id="tooltip">
        <div class="tooltip-date" id="tt-date"></div>
        <div class="tooltip-weight" id="tt-weight"></div>
        <div class="tooltip-avg" id="tt-avg" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ADD TAB -->
<div id="tab-add" class="page">
  <div class="section-label" style="margin-bottom:16px;">ìƒˆ ì²´ì¤‘ ê¸°ë¡</div>
  
  <div class="date-nav-wrapper">
    <button class="date-nav-btn" onclick="changeDate(-1)">â—€</button>
    <div class="form-group">
      <div class="form-label">ë‚ ì§œ</div>
      <input type="date" id="input-date" max="" />
    </div>
    <button class="date-nav-btn" onclick="changeDate(1)">â–¶</button>
  </div>
  
  <div class="weight-input-group">
    <div class="form-label">ì²´ì¤‘ (kg)</div>
    <input type="number" id="input-weight" step="0.1" min="20" max="300" placeholder="00.0" />
  </div>
  
  <button class="add-btn" onclick="addEntry()">ê¸°ë¡í•˜ê¸°</button>
</div>

<!-- HISTORY TAB -->
<div id="tab-history" class="page">
  <div class="section-label" id="history-label">ê¸°ë¡ ë‚´ì—­</div>
  <div id="history-list"></div>
</div>

<!-- BACKUP TAB -->
<div id="tab-backup" class="page">
  <div class="section-label" style="margin-bottom:16px;">ë°ì´í„° ë°±ì—… / ë³µì›</div>

  <div class="backup-grid">
    <button class="backup-btn" onclick="exportCSV()">
      <span class="backup-icon">ğŸ“¥</span>
      CSV ë‚´ë³´ë‚´ê¸°
      <div class="backup-desc">ì—‘ì…€ì—ì„œ ì—´ ìˆ˜ ìˆì–´ìš”</div>
    </button>
    <button class="backup-btn" onclick="exportJSON()">
      <span class="backup-icon">ğŸ’¾</span>
      JSON ë‚´ë³´ë‚´ê¸°
      <div class="backup-desc">ì™„ì „ ë°±ì—… íŒŒì¼</div>
    </button>
  </div>

  <button class="backup-btn" style="width:100%;margin-bottom:10px;" onclick="document.getElementById('import-file').click()">
    <span class="backup-icon">ğŸ“¤</span>
    JSON ê°€ì ¸ì˜¤ê¸°
    <div class="backup-desc">ë°±ì—… íŒŒì¼ë¡œ ë³µì›í•´ìš”</div>
  </button>
  <input type="file" id="import-file" class="file-input" accept=".json" onchange="importJSON(event)" />

  <button class="backup-btn danger" style="width:100%;" onclick="requestReset()">
    <span class="backup-icon">ğŸ—‘ï¸</span>
    ì „ì²´ ë°ì´í„° ì‚­ì œ
    <div class="backup-desc">ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”</div>
  </button>

  <div id="reset-confirm" style="display:none;margin-top:10px;">
    <div style="font-size:12px;color:var(--danger);text-align:center;margin-bottom:10px;letter-spacing:0.05em;font-weight:500;">ì •ë§ ì‚­ì œí• ê¹Œìš”? ë˜ëŒë¦´ ìˆ˜ ì—†ì–´ìš”.</div>
    <div style="display:flex;gap:8px;">
      <button class="backup-btn danger" style="flex:1;" onclick="confirmReset()">ë„¤, ì‚­ì œí• ê²Œìš”</button>
      <button class="backup-btn" style="flex:1;" onclick="cancelReset()">ì·¨ì†Œ</button>
    </div>
  </div>

  <div class="backup-info">
    ğŸ’¡ <strong style="color:var(--text)">ë°±ì—… íŒ</strong><br>
    í°ì„ ë°”ê¾¸ê±°ë‚˜ ì•±ì„ ì¬ì„¤ì¹˜í•˜ê¸° ì „ì—<br>
    JSON ë‚´ë³´ë‚´ê¸°ë¡œ ë°±ì—…í•´ë‘ì„¸ìš”.<br>
    ë‚˜ì¤‘ì— JSON ê°€ì ¸ì˜¤ê¸°ë¡œ ë³µì›í•  ìˆ˜ ìˆì–´ìš”.
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
  // â”€â”€ State â”€â”€
  let entries = JSON.parse(localStorage.getItem('wt-entries') || '[]');
  let deferredPrompt = null;
  let deletePending = null;

  // â”€â”€ PWA Install â”€â”€
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('install-banner').style.display = 'flex';
  });
  window.addEventListener('appinstalled', () => {
    document.getElementById('install-banner').style.display = 'none';
    deferredPrompt = null;
  });
  async function installApp() {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
    document.getElementById('install-banner').style.display = 'none';
  }

  // â”€â”€ Init â”€â”€
  const todayStr = getTodayStr();
  document.getElementById('input-date').value = todayStr;
  document.getElementById('input-date').max = todayStr;
  document.getElementById('input-date').addEventListener('change', loadExistingWeight);
  renderAll();

  // â”€â”€ Tabs â”€â”€
  function switchTab(tab) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    event.currentTarget.classList.add('active');
    deletePending = null;
    if (tab === 'history') renderHistory();
  }

  // â”€â”€ Date Navigation â”€â”€
  function changeDate(days) {
    const input = document.getElementById('input-date');
    const parts = input.value.split('-');
    const current = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    current.setDate(current.getDate() + days);
    
    // Prevent future dates
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (current > today) {
      return; // Don't change if it would go beyond today
    }
    
    const year = current.getFullYear();
    const month = String(current.getMonth() + 1).padStart(2, '0');
    const day = String(current.getDate()).padStart(2, '0');
    input.value = `${year}-${month}-${day}`;
    loadExistingWeight();
  }

  // â”€â”€ Load existing weight for selected date â”€â”€
  function loadExistingWeight() {
    const date = document.getElementById('input-date').value;
    const existing = entries.find(e => e.date === date);
    const weightInput = document.getElementById('input-weight');
    if (existing) {
      weightInput.value = existing.weight;
    } else {
      weightInput.value = '';
    }
  }

  // â”€â”€ Save â”€â”€
  function save() { localStorage.setItem('wt-entries', JSON.stringify(entries)); }

  // â”€â”€ Add Entry â”€â”€
  function addEntry() {
    const date = document.getElementById('input-date').value;
    const wStr = document.getElementById('input-weight').value;
    const w = parseFloat(wStr);
    if (!wStr || isNaN(w) || w < 20 || w > 300) { 
      showToast('ì˜¬ë°”ë¥¸ ì²´ì¤‘ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (20~300kg)', true); 
      return; 
    }
    if (!date) { 
      showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', true); 
      return; 
    }
    const entry = { id: Date.now(), date, weight: Math.round(w * 10) / 10 };
    entries = [...entries.filter(e => e.date !== date), entry].sort((a, b) => a.date.localeCompare(b.date));
    save();
    document.getElementById('input-weight').value = '';
    document.getElementById('input-date').value = getTodayStr();
    renderAll();
    showToast('ê¸°ë¡ë˜ì—ˆì–´ìš” âœ“');
    // Switch to home
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-home').classList.add('active');
    document.querySelector('.tab-btn').classList.add('active');
  }

  // â”€â”€ Delete â”€â”€
  function requestDelete(id) {
    deletePending = id;
    renderHistory();
  }
  function cancelDelete() { 
    deletePending = null; 
    renderHistory(); 
  }
  function confirmDelete(id) {
    entries = entries.filter(e => e.id !== id);
    save(); 
    deletePending = null;
    renderAll(); 
    renderHistory();
    showToast('ì‚­ì œë˜ì—ˆì–´ìš”');
  }

  // â”€â”€ Render All â”€â”€
  function renderAll() { 
    renderStats(); 
    renderChart(); 
  }

  // â”€â”€ Stats â”€â”€
  function renderStats() {
    const sorted = [...entries].sort((a, b) => a.date.localeCompare(b.date));
    const first = sorted[0];
    const latest = sorted[sorted.length - 1];
    const change = (latest && first && sorted.length > 1) ? latest.weight - first.weight : null;

    const el = id => document.getElementById(id);
    el('stat-start').innerHTML = first ? `${first.weight}<span class="stat-unit">kg</span>` : 'â€”';
    
    if (change !== null) {
      const cls = change < 0 ? 'green' : change > 0 ? 'red' : '';
      el('stat-change').className = `stat-val ${cls}`;
      el('stat-change').innerHTML = `${change > 0 ? '+' : ''}${change.toFixed(1)}<span class="stat-unit">kg</span>`;
    } else {
      el('stat-change').className = 'stat-val gray';
      el('stat-change').innerHTML = 'â€”';
    }
  }

  // â”€â”€ Calculate Weekly Averages â”€â”€
  function calculateWeeklyAverages(data) {
    if (data.length === 0) return [];
    
    const weeklyAvgs = [];
    const MS_PER_DAY = 86400000;
    
    // Group by weeks
    const weeks = {};
    data.forEach(entry => {
      const date = new Date(entry.date + 'T00:00:00');
      const weekStart = new Date(date);
      weekStart.setDate(date.getDate() - date.getDay()); // Sunday
      const weekKey = weekStart.toISOString().split('T')[0];
      
      if (!weeks[weekKey]) weeks[weekKey] = [];
      weeks[weekKey].push(entry);
    });
    
    // Calculate average for each week
    Object.keys(weeks).sort().forEach(weekKey => {
      const weekEntries = weeks[weekKey];
      const avgWeight = weekEntries.reduce((sum, e) => sum + e.weight, 0) / weekEntries.length;
      const midDate = weekEntries[Math.floor(weekEntries.length / 2)].date;
      weeklyAvgs.push({ date: midDate, weight: Math.round(avgWeight * 10) / 10 });
    });
    
    return weeklyAvgs;
  }

  // â”€â”€ Chart â”€â”€
  function renderChart() {
    const sorted = [...entries].sort((a, b) => a.date.localeCompare(b.date));
    const data = sorted.slice(-30);
    const svg = document.getElementById('chart-svg');
    const empty = document.getElementById('chart-empty');
    const lbl = document.getElementById('chart-label');

    if (data.length < 2) { 
      svg.style.display = 'none'; 
      empty.style.display = 'block'; 
      return; 
    }
    svg.style.display = 'block'; 
    empty.style.display = 'none';
    lbl.textContent = `ìµœê·¼ ${data.length}íšŒ ì¶”ì´`;

    const W = 560, H = 270, pad = { t: 18, b: 40, l: 48, r: 14 };
    const iW = W - pad.l - pad.r, iH = H - pad.t - pad.b;
    const ws = data.map(e => e.weight);
    
    // Calculate weekly averages
    const weeklyAvgs = calculateWeeklyAverages(data);
    const allWeights = [...ws, ...weeklyAvgs.map(w => w.weight)];
    
    const minV = Math.min(...allWeights) - 1, maxV = Math.max(...allWeights) + 1;
    const xStep = iW / (data.length - 1);

    const pts = data.map((e, i) => ({
      x: pad.l + i * xStep,
      y: pad.t + iH - ((e.weight - minV) / (maxV - minV)) * iH,
      entry: e,
      type: 'daily'
    }));

    // Weekly average points
    const weeklyPts = weeklyAvgs.map(avg => {
      const idx = data.findIndex(d => d.date >= avg.date);
      const x = idx === -1 ? pad.l + iW : (idx === 0 ? pad.l : pad.l + idx * xStep);
      return {
        x: x,
        y: pad.t + iH - ((avg.weight - minV) / (maxV - minV)) * iH,
        entry: avg,
        type: 'weekly'
      };
    });

    const linePath = pts.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`).join(' ');
    const areaPath = `M ${pts[0].x} ${pad.t + iH} ` + pts.map(p => `L ${p.x.toFixed(1)} ${p.y.toFixed(1)}`).join(' ') + ` L ${pts[pts.length - 1].x} ${pad.t + iH} Z`;
    
    const weeklyPath = weeklyPts.length > 1 
      ? weeklyPts.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`).join(' ')
      : '';

    // Y labels
    const yLabels = [0, 0.25, 0.5, 0.75, 1].map(t => ({
      val: (minV + (maxV - minV) * t).toFixed(1),
      y: pad.t + iH - t * iH
    }));
    
    // X labels
    const xLabels = data.map((e, i) => {
      const show = data.length <= 8 || i % Math.ceil(data.length / 7) === 0 || i === data.length - 1;
      return show ? { x: pts[i].x, label: fmtShort(e.date) } : null;
    }).filter(Boolean);

    svg.innerHTML = `
      <defs>
        <linearGradient id="g1" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#7fff7f" stop-opacity="0.16"/>
          <stop offset="100%" stop-color="#7fff7f" stop-opacity="0"/>
        </linearGradient>
      </defs>
      ${yLabels.map(l => `
        <line x1="${pad.l}" y1="${l.y.toFixed(1)}" x2="${W - pad.r}" y2="${l.y.toFixed(1)}" stroke="#1e1e1e" stroke-width="1"/>
        <text x="${pad.l - 7}" y="${(l.y + 4).toFixed(1)}" text-anchor="end" font-size="10" fill="#888" font-family="monospace" font-weight="500">${l.val}</text>
      `).join('')}
      ${xLabels.map(l => `<text x="${l.x.toFixed(1)}" y="${H - 10}" text-anchor="middle" font-size="9" fill="#888" font-family="monospace" font-weight="500">${l.label}</text>`).join('')}
      <path d="${areaPath}" fill="url(#g1)"/>
      <path d="${linePath}" fill="none" stroke="#7fff7f" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
      ${weeklyPath ? `<path d="${weeklyPath}" fill="none" stroke="#ffd700" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke-dasharray="4,4"/>` : ''}
      ${pts.map((p, i) => `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="4.5" fill="#2f2f2f" stroke="#7fff7f" stroke-width="2" data-i="${i}" data-type="daily" class="chart-pt" style="cursor:pointer;"/>`).join('')}
      ${weeklyPts.map((p, i) => `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="5" fill="#2f2f2f" stroke="#ffd700" stroke-width="2.5" data-i="${i}" data-type="weekly" class="chart-pt-avg" style="cursor:pointer;"/>`).join('')}
    `;

    // Tooltip events
    svg.querySelectorAll('.chart-pt').forEach(c => {
      c.addEventListener('mouseenter', (ev) => showTT(ev, pts, data, W, H, pad, 'daily'));
      c.addEventListener('touchstart', (ev) => { 
        ev.preventDefault(); 
        showTT(ev.touches[0], pts, data, W, H, pad, 'daily'); 
      }, { passive: false });
      c.addEventListener('mouseleave', () => { document.getElementById('tooltip').style.display = 'none'; });
      c.addEventListener('touchend', () => setTimeout(() => { document.getElementById('tooltip').style.display = 'none'; }, 1400));
    });
    
    svg.querySelectorAll('.chart-pt-avg').forEach(c => {
      c.addEventListener('mouseenter', (ev) => showTT(ev, weeklyPts, weeklyAvgs, W, H, pad, 'weekly'));
      c.addEventListener('touchstart', (ev) => { 
        ev.preventDefault(); 
        showTT(ev.touches[0], weeklyPts, weeklyAvgs, W, H, pad, 'weekly'); 
      }, { passive: false });
      c.addEventListener('mouseleave', () => { document.getElementById('tooltip').style.display = 'none'; });
      c.addEventListener('touchend', () => setTimeout(() => { document.getElementById('tooltip').style.display = 'none'; }, 1400));
    });
  }

  function showTT(ev, pts, data, W, H, pad, type) {
    const target = ev.currentTarget || ev.target;
    const i = parseInt(target?.dataset?.i ?? (ev.currentTarget?.dataset?.i ?? 0));
    const p = pts[i], e = data[i];
    const wrap = document.querySelector('.chart-wrap');
    const rect = wrap.getBoundingClientRect();
    const svgEl = document.getElementById('chart-svg');
    const svgRect = svgEl.getBoundingClientRect();
    const scaleX = svgRect.width / W;
    const scaleY = svgRect.height / H;
    const tt = document.getElementById('tooltip');
    
    document.getElementById('tt-date').textContent = fmtFull(e.date);
    
    if (type === 'weekly') {
      document.getElementById('tt-weight').style.display = 'none';
      document.getElementById('tt-avg').style.display = 'block';
      document.getElementById('tt-avg').textContent = `ì£¼ê°„ í‰ê· : ${e.weight} kg`;
    } else {
      document.getElementById('tt-weight').style.display = 'block';
      document.getElementById('tt-avg').style.display = 'none';
      document.getElementById('tt-weight').textContent = `${e.weight} kg`;
    }
    
    tt.style.display = 'block';
    const ttW = tt.offsetWidth;
    let left = svgRect.left - rect.left + p.x * scaleX - ttW / 2;
    let top = svgRect.top - rect.top + p.y * scaleY - tt.offsetHeight - 12;
    left = Math.max(5, Math.min(left, rect.width - ttW - 5));
    if (top < 3) top = svgRect.top - rect.top + p.y * scaleY + 16;
    tt.style.left = left + 'px';
    tt.style.top = top + 'px';
  }

  // â”€â”€ History â”€â”€
  function renderHistory() {
    const sorted = [...entries].sort((a, b) => b.date.localeCompare(a.date));
    const lbl = document.getElementById('history-label');
    if (lbl) lbl.textContent = `ê¸°ë¡ ë‚´ì—­ (${entries.length})`;
    const list = document.getElementById('history-list');
    if (!entries.length) {
      list.innerHTML = '<div class="empty-state">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.<br>ê¸°ë¡í•˜ê¸° íƒ­ì—ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>';
      return;
    }
    // For delta: need ascending order
    const asc = [...entries].sort((a, b) => a.date.localeCompare(b.date));
    list.innerHTML = sorted.map((e) => {
      const idx = asc.findIndex(x => x.id === e.id);
      const prev = asc[idx - 1];
      const delta = prev ? e.weight - prev.weight : null;
      const deltaTxt = delta !== null ? `<span class="hist-delta ${delta < 0 ? 'green' : delta > 0 ? 'red' : 'gray'}">${delta > 0 ? '+' : ''}${delta.toFixed(1)}</span>` : '';
      const actions = deletePending === e.id
        ? `<div class="del-actions">
             <button class="del-btn del-confirm" onclick="confirmDelete(${e.id})">ì‚­ì œ</button>
             <button class="del-btn cancel-btn" onclick="cancelDelete()">ì·¨ì†Œ</button>
           </div>`
        : `<button class="del-btn" onclick="requestDelete(${e.id})">ì‚­ì œ</button>`;
      return `<div class="history-item">
        <div>
          <div class="hist-date">${fmtFull(e.date)}</div>
          <div><span class="hist-weight">${e.weight}<span class="hist-unit"> kg</span></span>${deltaTxt}</div>
        </div>
        ${actions}
      </div>`;
    }).join('');
  }

  // â”€â”€ Export CSV â”€â”€
  function exportCSV() {
    if (!entries.length) { showToast('ê¸°ë¡ì´ ì—†ì–´ìš”', true); return; }
    const sorted = [...entries].sort((a, b) => a.date.localeCompare(b.date));
    const rows = [['ë‚ ì§œ', 'ì²´ì¤‘(kg)'], ...sorted.map(e => [e.date, e.weight])];
    const csv = '\uFEFF' + rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
    downloadFile(csv, `ì²´ì¤‘ê¸°ë¡_${getTodayStr()}.csv`, 'text/csv;charset=utf-8;');
    showToast('CSV íŒŒì¼ì´ ì €ì¥ëì–´ìš” ğŸ“¥');
  }

  // â”€â”€ Export JSON â”€â”€
  function exportJSON() {
    if (!entries.length) { showToast('ê¸°ë¡ì´ ì—†ì–´ìš”', true); return; }
    const data = JSON.stringify({ version: 2, exportedAt: new Date().toISOString(), entries }, null, 2);
    downloadFile(data, `ì²´ì¤‘ê¸°ë¡_ë°±ì—…_${getTodayStr()}.json`, 'application/json');
    showToast('JSON ë°±ì—… íŒŒì¼ì´ ì €ì¥ëì–´ìš” ğŸ’¾');
  }

  // â”€â”€ Import JSON â”€â”€
  function importJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        let imported = [];
        if (Array.isArray(data)) { imported = data; }
        else if (data.entries && Array.isArray(data.entries)) { imported = data.entries; }
        else { showToast('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹ˆì—ìš”', true); return; }
        if (!imported.length) { showToast('ë°ì´í„°ê°€ ì—†ëŠ” íŒŒì¼ì´ì—ìš”', true); return; }
        // Merge: imported takes priority by date
        const merged = [...entries];
        imported.forEach(imp => {
          const idx = merged.findIndex(e => e.date === imp.date);
          if (idx >= 0) merged[idx] = imp;
          else merged.push(imp);
        });
        entries = merged.sort((a, b) => a.date.localeCompare(b.date));
        save(); renderAll();
        showToast(`${imported.length}ê°œ ê¸°ë¡ì„ ë³µì›í–ˆì–´ìš” âœ“`);
      } catch {
        showToast('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ì–´ìš”', true);
      }
      event.target.value = '';
    };
    reader.readAsText(file);
  }

  // â”€â”€ Reset â”€â”€
  function requestReset() {
    document.getElementById('reset-confirm').style.display = 'block';
  }
  function cancelReset() {
    document.getElementById('reset-confirm').style.display = 'none';
  }
  function confirmReset() {
    entries = [];
    save(); renderAll();
    document.getElementById('reset-confirm').style.display = 'none';
    showToast('ì „ì²´ ë°ì´í„°ê°€ ì‚­ì œëì–´ìš”');
  }

  // â”€â”€ Download Helper â”€â”€
  function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // â”€â”€ Toast â”€â”€
  function showToast(msg, isErr = false) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast' + (isErr ? ' error' : '');
    t.classList.add('show');
    clearTimeout(t._timer);
    t._timer = setTimeout(() => t.classList.remove('show'), 2600);
  }

  // â”€â”€ Helpers â”€â”€
  function getTodayStr() { return new Date().toISOString().split('T')[0]; }
  function fmtShort(d) { 
    const dt = new Date(d + 'T00:00:00'); 
    return dt.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }); 
  }
  function fmtFull(d) { 
    const dt = new Date(d + 'T00:00:00'); 
    return dt.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }); 
  }

  // â”€â”€ Service Worker â”€â”€
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }
</script>
</body>
</html>
